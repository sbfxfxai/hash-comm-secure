<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Enhanced Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' ws: wss: https: http://localhost:*; img-src 'self' data: https:; media-src 'self' blob: data:; worker-src 'self' blob:;" />
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp" />
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin" />
    <meta http-equiv="X-Content-Type-Options" content="nosniff" />
    <meta http-equiv="X-Frame-Options" content="DENY" />
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin" />
    <meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=(), payment=()" />

    <title>BitComm - Decentralized Secure Communication</title>
    <meta name="description" content="BitComm: Decentralized, peer-to-peer secure messaging with Bitcoin Lightning payments and end-to-end encryption" />
    <meta name="author" content="BitComm Team" />
    <meta name="keywords" content="decentralized, p2p, secure messaging, bitcoin, lightning network, encryption, privacy" />

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="BitComm - Decentralized Secure Communication" />
    <meta property="og:description" content="Peer-to-peer secure messaging with Bitcoin Lightning payments and end-to-end encryption" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://bitcomm.email" />
    <meta property="og:image" content="/og-image.png" />
    <meta property="og:site_name" content="BitComm" />

    <!-- Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="BitComm - Decentralized Secure Communication" />
    <meta name="twitter:description" content="Peer-to-peer secure messaging with Bitcoin Lightning payments" />
    <meta name="twitter:image" content="/og-image.png" />
    <meta name="twitter:creator" content="@bitcomm" />

    <!-- Enhanced Alby Meta Tags for Lightning Integration -->
    <meta property="alby:name" content="BitComm" />
    <meta property="alby:image" content="/favicon.svg" />
    <meta property="alby:description" content="Decentralized Communication Platform powered by Bitcoin Lightning Network" />
    <meta property="alby:recipient" content="excitementresourceful193152@getalby.com" />
    <meta name="lightning" content="excitementresourceful193152@getalby.com" />
    <meta name="lnurl" content="excitementresourceful193152@getalby.com" />

    <!-- DNS prefetch and preconnect for performance -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com" />
    <link rel="dns-prefetch" href="//fonts.gstatic.com" />
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <!-- Critical resource preloading -->
    <link rel="modulepreload" href="/src/main.tsx" />
    <link rel="modulepreload" href="/src/App.tsx" />
    <link rel="modulepreload" href="/src/lib/bitcomm.ts" />

    <!-- Theme and PWA configuration -->
    <meta name="theme-color" content="#f97316" />
    <meta name="msapplication-TileColor" content="#f97316" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="BitComm" />

    <!-- Icons and manifest -->
    <link rel="apple-touch-icon" href="/bitcomm-logo.svg" />
    <link rel="apple-touch-startup-image" href="/bitcomm-logo.svg" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="alternate icon" href="/favicon.ico" />

    <!-- Critical CSS for immediate rendering -->
    <style>
        @layer critical {
            /* Enhanced reset and base styles */
            *, *::before, *::after {
                box-sizing: border-box;
                border: 0 solid hsl(214.3 31.8% 91.4%);
            }

            html {
                line-height: 1.5;
                font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                -webkit-text-size-adjust: 100%;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }

            body {
                margin: 0;
                min-height: 100vh;
                background: hsl(0 0% 100%);
                color: hsl(222.2 84% 4.9%);
                scroll-behavior: smooth;
            }

            /* Enhanced CSS custom properties */
            :root {
                --background: 0 0% 100%;
                --foreground: 222.2 84% 4.9%;
                --primary: 29 78% 51%;
                --bitcoin-orange: 29 78% 51%;
                --border: 214.3 31.8% 91.4%;
                --muted: 210 40% 96.1%;
                --accent: 210 40% 98%;
                --destructive: 0 84.2% 60.2%;
                --success: 142.1 76.2% 36.3%;
                --warning: 38 92% 50%;
                --shadow: 0deg 0% 0% / 0.1;
            }

            @media (prefers-color-scheme: dark) {
                :root {
                    --background: 222.2 84% 4.9%;
                    --foreground: 210 40% 98%;
                    --muted: 217.2 32.6% 17.5%;
                    --accent: 217.2 32.6% 17.5%;
                    --border: 217.2 32.6% 17.5%;
                }

                body {
                    background: hsl(var(--background));
                    color: hsl(var(--foreground));
                }
            }

            /* Essential utility classes for above-the-fold */
            .min-h-screen {
                min-height: 100vh;
            }

            .bg-background {
                background: hsl(var(--background));
            }

            .text-foreground {
                color: hsl(var(--foreground));
            }

            .flex {
                display: flex;
            }

            .items-center {
                align-items: center;
            }

            .justify-between {
                justify-content: space-between;
            }

            .justify-center {
                justify-content: center;
            }

            .gap-2 {
                gap: 0.5rem;
            }

            .gap-4 {
                gap: 1rem;
            }

            .p-4 {
                padding: 1rem;
            }

            .px-4 {
                padding-left: 1rem;
                padding-right: 1rem;
            }

            .py-2 {
                padding-top: 0.5rem;
                padding-bottom: 0.5rem;
            }

            .border-b {
                border-bottom-width: 1px;
            }

            .text-xl {
                font-size: 1.25rem;
                line-height: 1.75rem;
            }

            .text-2xl {
                font-size: 1.5rem;
                line-height: 2rem;
            }

            .font-bold {
                font-weight: 700;
            }

            .font-semibold {
                font-weight: 600;
            }

            .h-6 {
                height: 1.5rem;
            }

            .w-6 {
                width: 1.5rem;
            }

            .h-8 {
                height: 2rem;
            }

            .w-8 {
                width: 2rem;
            }

            .h-16 {
                height: 4rem;
            }

            .text-bitcoin-orange {
                color: hsl(var(--bitcoin-orange));
            }

            .ml-auto {
                margin-left: auto;
            }

            .flex-1 {
                flex: 1 1 0%;
            }

            .relative {
                position: relative;
            }

            .absolute {
                position: absolute;
            }

            .inset-0 {
                top: 0;
                right: 0;
                bottom: 0;
                left: 0;
            }

            .rounded-lg {
                border-radius: 0.5rem;
            }

            .rounded-full {
                border-radius: 9999px;
            }

            .bg-muted {
                background: hsl(var(--muted));
            }

            .bg-primary {
                background: hsl(var(--primary));
            }

            .text-white {
                color: white;
            }

            .shadow-lg {
                box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1);
            }

            .transition-all {
                transition: all 150ms cubic-bezier(0.4, 0, 0.2, 1);
            }

            .hover-scale:hover {
                transform: scale(1.05);
            }

            /* Loading animations */
            .animate-pulse {
                animation: pulse 2s infinite;
            }

            .animate-spin {
                animation: spin 1s linear infinite;
            }

            .animate-bounce {
                animation: bounce 1s infinite;
            }

            @keyframes pulse {
                0%, 100% {
                    opacity: 1;
                }

                50% {
                    opacity: 0.5;
                }
            }

            @keyframes spin {
                from {
                    transform: rotate(0deg);
                }

                to {
                    transform: rotate(360deg);
                }
            }

            @keyframes bounce {
                0%, 100% {
                    transform: translateY(-25%);
                    animation-timing-function: cubic-bezier(0.8, 0, 1, 1);
                }

                50% {
                    transform: translateY(0);
                    animation-timing-function: cubic-bezier(0, 0, 0.2, 1);
                }
            }

            /* Loading screen styles */
            .loading-screen {
                position: fixed;
                inset: 0;
                background: hsl(var(--background));
                display: flex;
                align-items: center;
                justify-content: center;
                flex-direction: column;
                z-index: 9999;
            }

            .loading-logo {
                width: 4rem;
                height: 4rem;
                color: hsl(var(--bitcoin-orange));
                margin-bottom: 1rem;
            }
        }
    </style>

    <!-- Fixed cache-busting script with proper build timestamp -->
    <script>
        // Cache management with proper build versioning
        (function () {
            // This should be replaced by your build process with actual build timestamp
            const BUILD_VERSION = '1.0.0'; // Replace with actual version
            const BUILD_TIME = 1722672000000; // Replace with actual build timestamp
            const CACHE_KEY = 'bitcomm_build_version';
            const lastVersion = localStorage.getItem(CACHE_KEY);

            // Check if we need a cache refresh
            if (lastVersion !== BUILD_VERSION) {
                console.log('ðŸ”„ New version detected, clearing cache...', { old: lastVersion, new: BUILD_VERSION });

                // Clear all caches
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => {
                            console.log('ðŸ—‘ï¸ Clearing cache:', name);
                            caches.delete(name);
                        });
                    });
                }

                // Unregister service workers
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistrations().then(registrations => {
                        registrations.forEach(reg => {
                            console.log('ðŸ—‘ï¸ Unregistering SW:', reg.scope);
                            reg.unregister();
                        });
                    });
                }

                // Clear storage but preserve essential data
                try {
                    const preserveKeys = ['bitcomm_identities', 'bitcomm_contacts', 'bitcomm_settings'];
                    const preserved = {};
                    preserveKeys.forEach(key => {
                        const value = localStorage.getItem(key);
                        if (value) preserved[key] = value;
                    });

                    localStorage.clear();
                    sessionStorage.clear();

                    // Restore preserved data
                    Object.entries(preserved).forEach(([key, value]) => {
                        localStorage.setItem(key, value);
                    });

                    localStorage.setItem(CACHE_KEY, BUILD_VERSION);
                } catch (e) {
                    console.warn('Storage access failed:', e);
                }
            } else {
                localStorage.setItem(CACHE_KEY, BUILD_VERSION);
            }
        })();
    </script>
</head>

<body>
    <!-- Loading screen HTML -->
    <div id="loading-screen" class="loading-screen">
        <svg class="loading-logo animate-bounce" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round" />
            <path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linejoin="round" />
            <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linejoin="round" />
        </svg>
        <p class="text-xl font-semibold text-bitcoin-orange">Loading BitComm...</p>
        <p class="text-sm text-muted-foreground">Initializing secure connections</p>
    </div>

    <div id="root"></div>

    <!-- Enhanced script loading -->
    <script type="module" src="/src/main.tsx" defer></script>

    <!-- Hide loading screen once app loads -->
    <script>
        // Remove loading screen once React app mounts
        window.addEventListener('load', () => {
            setTimeout(() => {
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.style.opacity = '0';
                    loadingScreen.style.transition = 'opacity 0.3s ease-out';
                    setTimeout(() => loadingScreen.remove(), 300);
                }
            }, 500); // Small delay to ensure smooth transition
        });
    </script>
</body>
</html>